#!/bin/bash
set -o nounset -o errexit -o errtrace -o pipefail

export MOODLE_DOCKER_BASE="$(realpath "$(dirname "$0")/..")"
export PATH="$MOODLE_DOCKER_BASE/bin:$PATH"

if [[ -f "$MOODLE_DOCKER_BASE/.env" ]]; then
    set -o allexport
    . "$MOODLE_DOCKER_BASE/.env"
    set +o allexport
fi

install_xdebug() {
    local bash_args="-o nounset -o errexit -o errtrace"
    # Pass shell debug option from host to container.
    test -o xtrace && bash_args="$bash_args -x" || true
    
    mdc exec -T webserver bash $bash_args <<EOF1
pecl shell-test xdebug || pecl install xdebug

mkdir -p /usr/local/etc/php/conf.d
cat >/usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini <<EOF2
; Settings for Xdebug Docker configuration
xdebug.mode = debug
xdebug.client_host = host.docker.internal
EOF2

docker-php-ext-enable xdebug
EOF1
    mdc restart webserver
}

install_moodle_db() {
    # From https://docs.moodle.org/402/en/Administration_via_command_line#Installation
    mdc php admin/cli/install_database.php --agree-license \
	--adminpass=admin --adminemail=a@b.c \
	--supportemail=a@b.c \
	--fullname="Moodle-Docker" --shortname="moodle-docker"
}

case "${1:-}" in
    xdebug)
	install_xdebug
	;;
    install)
	install_moodle_db
	;;
    psql)
	shift
	exec "$0" exec -it db psql -U moodle "$@"
	;;
    php)
	shift
	exec moodle-docker-php "$@"
	;;
    *)
	exec moodle-docker-compose "$@"
	;;
esac

